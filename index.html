<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Drive - Google Drive</title>
    <link rel="shortcut icon" href="https://ssl.gstatic.com/docs/doclist/images/drive_2022q3_32dp.ico" type="image/x-icon">
    <style>
        :root { --primary: #007bff; --accent: #6f42c1; --danger: #ff4444; --bg: #121212; --card-bg: #1e1e1e; }
        
        body { background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; margin: 0; overflow-x: hidden; }
        
        /* Overlays */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 2000; display: flex; align-items: center; justify-content: center; text-align: center; }
        #news-overlay { background: rgba(0,0,0,0.9); z-index: 3000; }
        .modal-box { background: var(--card-bg); padding: 40px; border-radius: 15px; border: 1px solid #333; width: 320px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        /* Header & Stats */
        header { text-align: center; padding: 20px; background: #1a1a1a; border-bottom: 1px solid #333; }
        .stats-bar { max-width: 1200px; margin: 10px auto; padding: 0 20px; color: #888; font-size: 13px; display: flex; justify-content: space-between; }
        
        .search-row { display: flex; justify-content: center; gap: 8px; margin: 15px auto; max-width: 650px; padding: 0 20px; }
        input[type="text"] { flex-grow: 1; padding: 12px 20px; border-radius: 25px; border: 1px solid #444; background: #222; color: white; outline: none; }
        
        .category-bar { display: flex; justify-content: center; gap: 8px; flex-wrap: wrap; margin-bottom: 20px; padding: 0 20px; }
        .cat-btn { background: #333; color: #ccc; border: none; padding: 8px 16px; border-radius: 20px; cursor: pointer; transition: 0.3s; }
        .cat-btn.active { background: var(--primary); color: white; }

        /* Grid & Cards */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; padding: 20px; max-width: 1200px; margin: 0 auto; }
        .card { background: var(--card-bg); border-radius: 12px; border: 1px solid #333; position: relative; transition: 0.3s; overflow: hidden; display: flex; flex-direction: column; }
        .card:hover { border-color: var(--primary); transform: translateY(-5px); }
        .card-img { width: 100%; height: 130px; object-fit: cover; background: #2a2a2a; }
        .card-content { padding: 12px; flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between; }
        .card h3 { margin: 0 0 5px 0; font-size: 16px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .play-count { font-size: 10px; color: #666; margin-bottom: 10px; }

        .fav-btn { position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.6); border: none; font-size: 18px; cursor: pointer; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; z-index: 5; }
        .fav-btn.active { color: #ffca28; }
        
        /* Buttons */
        .btn { padding: 8px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 12px; transition: 0.2s; }
        .play-btn { background: var(--primary); color: white; }
        .pop-btn { background: #28a745; color: white; }
        .rand-btn { background: var(--accent); color: white; border-radius: 25px; padding: 0 20px; }
        .req-btn { background: #444; color: white; border-radius: 25px; padding: 0 20px; }
        .reset-btn { background: #444; color: white; flex: 1; border-radius: 0; }
        .close-btn { background: var(--danger); color: white; flex: 2; border-radius: 0; }

        /* Player Overlay */
        #player-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; display: none; flex-direction: column; z-index: 4000; }
        #player-overlay.active { display: flex; }
        .player-controls { display: flex; height: 45px; }
        iframe { flex-grow: 1; border: none; background: #000; }
        
        footer { text-align: center; padding: 20px; color: #444; font-size: 12px; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="login-overlay" class="overlay">
        <div class="modal-box">
            <h2 style="margin-top:0">Portal Access</h2>
            <input type="text" id="player-input" placeholder="Enter Name..." maxlength="12" style="width:85%; padding: 10px; margin-bottom: 20px; border-radius: 5px; border: 1px solid #444; background: #222; color: white; text-align: center;">
            <button class="btn play-btn" id="login-confirm" style="width:95%">LOGIN</button>
        </div>
    </div>

    <div id="news-overlay" class="overlay hidden">
        <div class="modal-box" style="border-color: var(--primary);">
            <h2 style="color: var(--primary); margin-top:0;">Updates</h2>
            <div id="news-content" style="text-align: left; margin: 15px 0; color: #bbb; font-size: 14px; line-height: 1.6;">
                • Tab Cloaker: Site now looks like Google Drive.<br>
                • Keep-Alive: Games stay active in background.<br>
                • Manual Reset: Restart games without refreshing.<br>
                • Requests: Suggest games via the Request button!
            </div>
            <button class="btn play-btn" id="news-close" style="width: 100%;">START BROWSING</button>
        </div>
    </div>

    <header>
        <h1 style="margin:0; font-size: 24px;">RESOURCE PORTAL</h1>
        <div class="stats-bar">
            <span id="stat-name">Player: ---</span>
            <span id="stat-total">Total Plays: 0</span>
        </div>
        <div class="search-row">
            <input type="text" id="game-search" placeholder="Search resources...">
            <button class="btn rand-btn" id="random-btn">RANDOM</button>
            <button class="btn req-btn" id="request-btn">REQUEST</button>
        </div>
        <div id="category-bar" class="category-bar"></div>
    </header>

    <div id="game-grid" class="grid"></div>

    <div id="player-overlay">
        <div class="player-controls">
            <button class="btn close-btn" id="back-btn">← BACK TO MENU</button>
            <button class="btn reset-btn" id="force-reset">↻ RESET GAME</button>
        </div>
        <iframe id="game-frame" src=""></iframe>
    </div>

    <footer>Emergency Key: <strong>P</strong></footer>

    <script>
        // State & Storage
        let allGames = [];
        let currentCategory = "All";
        let userData = JSON.parse(localStorage.getItem('portalProfile')) || { name: "", favorites: [], history: {} };

        // DOM References
        const grid = document.getElementById('game-grid');
        const pOverlay = document.getElementById('player-overlay');
        const lOverlay = document.getElementById('login-overlay');
        const nOverlay = document.getElementById('news-overlay');
        const frame = document.getElementById('game-frame');
        const searchInput = document.getElementById('game-search');

        // --- IDENTITY ---
        if (userData.name) lOverlay.classList.add('hidden');

        document.getElementById('login-confirm').onclick = () => {
            const val = document.getElementById('player-input').value.trim();
            if (val) {
                userData.name = val;
                save();
                lOverlay.classList.add('hidden');
                nOverlay.classList.remove('hidden');
                updateUI();
            }
        };

        document.getElementById('news-close').onclick = () => nOverlay.classList.add('hidden');

        function save() { localStorage.setItem('portalProfile', JSON.stringify(userData)); }

        function updateUI() {
            document.getElementById('stat-name').textContent = `Player: ${userData.name}`;
            const total = Object.values(userData.history).reduce((a, b) => a + b, 0);
            document.getElementById('stat-total').textContent = `Total Plays: ${total}`;
        }

        // --- GAME LOGIC ---
        function openGame(game) {
            if (frame.src !== game.url) {
                frame.src = game.url;
                userData.history[game.title] = (userData.history[game.title] || 0) + 1;
                save();
            }
            pOverlay.classList.add('active');
            updateUI();
            render();
        }

        function popOut(game) {
            const win = window.open('about:blank', '_blank');
            win.document.body.style.margin = "0";
            win.document.body.innerHTML = `<iframe src="${game.url}" style="width:100vw;height:100vh;border:none;"></iframe>`;
            userData.history[game.title] = (userData.history[game.title] || 0) + 1;
            save(); updateUI(); render();
        }

        function render() {
            grid.innerHTML = '';
            const term = searchInput.value.toLowerCase();
            let filtered = allGames.filter(g => {
                const matchSearch = g.title.toLowerCase().includes(term);
                const matchCat = currentCategory === "All" || g.category === currentCategory;
                return matchSearch && matchCat;
            });

            filtered.sort((a, b) => {
                const aFav = userData.favorites.includes(a.title);
                const bFav = userData.favorites.includes(b.title);
                if (aFav !== bFav) return bFav - aFav;
                return (userData.history[b.title] || 0) - (userData.history[a.title] || 0);
            });

            filtered.forEach(game => {
                const isFav = userData.favorites.includes(game.title);
                const plays = userData.history[game.title] || 0;
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <button class="fav-btn ${isFav ? 'active' : ''}">★</button>
                    <img src="${game.image || 'https://via.placeholder.com/200x130?text=No+Image'}" class="card-img" loading="lazy">
                    <div class="card-content">
                        <h3>${game.title}</h3>
                        <div class="play-count">Played: ${plays} times</div>
                        <div style="display:flex; gap:5px;">
                            <button class="btn play-btn" onclick="playIdx('${game.title.replace(/'/g, "\\'")}')">PLAY</button>
                            <button class="btn pop-btn" onclick="popIdx('${game.title.replace(/'/g, "\\'")}')">POP</button>
                        </div>
                    </div>
                `;
                card.querySelector('.fav-btn').onclick = (e) => {
                    e.stopPropagation();
                    if (isFav) userData.favorites = userData.favorites.filter(f => f !== game.title);
                    else userData.favorites.push(game.title);
                    save(); render();
                };
                grid.appendChild(card);
            });
        }

        window.playIdx = (title) => openGame(allGames.find(g => g.title === title));
        window.popIdx = (title) => popOut(allGames.find(g => g.title === title));

        function setupCats() {
            const cats = ["All", ...new Set(allGames.map(g => g.category).filter(Boolean))];
            catBar.innerHTML = '';
            cats.forEach(c => {
                const b = document.createElement('button');
                b.className = `cat-btn ${c === currentCategory ? 'active' : ''}`;
                b.textContent = c;
                b.onclick = () => { currentCategory = c; setupCats(); render(); };
                catBar.appendChild(b);
            });
        }

        // --- BUTTONS & PANIC ---
        document.getElementById('back-btn').onclick = () => pOverlay.classList.remove('active');
        
        document.getElementById('force-reset').onclick = () => {
            if(confirm("Restart game? Progress may be lost.")) {
                const s = frame.src; frame.src = "";
                setTimeout(() => { frame.src = s; }, 50);
            }
        };

        document.getElementById('random-btn').onclick = () => {
            if(allGames.length) openGame(allGames[Math.floor(Math.random()*allGames.length)]);
        };

        document.getElementById('request-btn').onclick = () => {
            const email = "elangford28@gulfstreamschool.org"; 
            const body = "Game Name: %0D%0AGame Link: ";
            window.location.href = `mailto:${email}?subject=Game Request&body=${body}`;
        };

        window.onkeydown = (e) => {
            if (e.key.toLowerCase() === 'p') {
                frame.src = ""; window.location.href = "https://www.google.com";
            }
        };

        // --- INIT ---
        async function init() {
            try {
                const res = await fetch('games.json');
                allGames = await res.json();
                setupCats(); render(); updateUI();
            } catch (e) { console.error("Error loading games.json", e); }
        }

        searchInput.oninput = () => render();
        init();
    </script>
</body>
</html>
